{% extends "admin/base_site.html" %}
{% load i18n %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; {% trans 'Workflow Monitor' %}
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<!-- Tailwind CSS, DaisyUI, and Alpine.js -->
<link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<script src="//unpkg.com/alpinejs" defer></script>
<!-- ECharts for visualization -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
<script>
    // Set DaisyUI theme based on system preference
    function setThemeFromSystemPreference() {
        const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', prefersDarkMode ? 'dark' : 'light');
    }
    setThemeFromSystemPreference();
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', setThemeFromSystemPreference);
</script>
{% endblock %}

{% block content %}
<div id="content-main" x-data="workflowMonitor()" x-init="init()">
    <h1 class="text-xl font-bold mb-4">Workflow Monitor (DBOS)</h1>

    <!-- Compact Control Panel with Inline Stats -->
    <div class="bg-base-200 rounded-lg p-4 mb-4">
        <div class="flex flex-wrap gap-4 items-center justify-between">
            <div class="grid grid-cols-3 gap-2 items-center">
                <button 
                    @click="togglePolling()" 
                    :class="isPolling ? 'btn-error' : 'btn-success'"
                    class="btn btn-sm"
                    x-text="isPolling ? 'Stop Polling' : 'Start Polling'">
                </button>
                
                <button @click="fetchData()" class="btn btn-primary btn-sm">
                    Refresh Now
                </button>
                
                <select 
                    x-model="pollingInterval" 
                    @change="changeInterval()"
                    class="select select-bordered select-sm w-full">
                    <option value="500">0.5s</option>
                    <option value="1000">1s</option>
                    <option value="2000">2s</option>
                    <option value="5000">5s</option>
                    <option value="10000">10s</option>
                    <option value="30000">30s</option>
                    <option value="60000">1m</option>
                </select>
            </div>
            
            <!-- Inline Stats -->
            <div class="flex gap-4 text-sm items-center">
                <div><span class="font-semibold text-warning">Enqueued:</span> <span x-text="stats.enqueued">0</span></div>
                <div><span class="font-semibold text-info">Pending:</span> <span x-text="stats.pending">0</span></div>
                <div><span class="font-semibold text-success">Success:</span> <span x-text="stats.success">0</span></div>
                <div><span class="font-semibold text-error">Error:</span> <span x-text="stats.error">0</span></div>
                <div><span class="font-semibold text-secondary">Cancelled:</span> <span x-text="stats.cancelled">0</span></div>
                <div><span class="font-semibold">Total:</span> <span x-text="stats.total">0</span></div>
                <div><span class="font-semibold text-xs">Updated:</span> <span class="text-xs opacity-70" x-text="stats.timestamp">-</span></div>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="bg-base-200 rounded-lg p-4 mb-4">
        <div id="combined-chart" class="w-full h-64"></div>
    </div>

</div>

<script>
function workflowMonitor() {
    return {
        // State
        isPolling: false,
        pollingInterval: 1000,
        pollingIntervalId: null,
        chart: null,
        
        // Data
        stats: {
            enqueued: 0,
            pending: 0,
            total: 0,
            success: 0,
            error: 0,
            cancelled: 0,
            timestamp: '-'
        },
        queueData: [],
        
        // Chart data
        maxDataPoints: 60,
        chartData: {
            labels: [],
            totalWorkflows: [],
            enqueued: [],
            pending: [],
            success: [],
            error: [],
            cancelled: []
        },
        
        init() {
            this.initChart();
            this.fetchData();
        },
        
        initChart() {
            const chartDom = document.getElementById('combined-chart');
            this.chart = echarts.init(chartDom);
            
            // Get current theme
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            
            const option = {
                backgroundColor: 'transparent',
                title: {
                    text: '',
                },
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['Total Workflows', 'Enqueued', 'Pending', 'Success', 'Error', 'Cancelled'],
                    bottom: 0,
                    textStyle: {
                        color: isDark ? '#a6adba' : '#374151'
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: this.chartData.labels,
                    axisLine: {
                        lineStyle: {
                            color: isDark ? '#4a5568' : '#e5e7eb'
                        }
                    },
                    axisLabel: {
                        color: isDark ? '#a6adba' : '#6b7280'
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: {
                        show: true,
                        lineStyle: {
                            color: isDark ? '#4a5568' : '#e5e7eb'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    axisLabel: {
                        color: isDark ? '#a6adba' : '#6b7280'
                    }
                },
                series: [
                    {
                        name: 'Total Workflows',
                        type: 'line',
                        smooth: true,
                        data: this.chartData.totalWorkflows,
                        lineStyle: { width: 2 },
                        itemStyle: { color: '#3b82f6' }
                    },
                    {
                        name: 'Enqueued',
                        type: 'line',
                        smooth: true,
                        data: this.chartData.enqueued,
                        lineStyle: { width: 2 },
                        itemStyle: { color: '#f59e0b' }
                    },
                    {
                        name: 'Pending',
                        type: 'line',
                        smooth: true,
                        data: this.chartData.pending,
                        lineStyle: { width: 2 },
                        itemStyle: { color: '#06b6d4' }
                    },
                    {
                        name: 'Success',
                        type: 'line',
                        smooth: true,
                        data: this.chartData.success,
                        lineStyle: { width: 2 },
                        itemStyle: { color: '#10b981' }
                    },
                    {
                        name: 'Error',
                        type: 'line',
                        smooth: true,
                        data: this.chartData.error,
                        lineStyle: { width: 2 },
                        itemStyle: { color: '#ef4444' }
                    },
                    {
                        name: 'Cancelled',
                        type: 'line',
                        smooth: true,
                        data: this.chartData.cancelled,
                        lineStyle: { width: 2 },
                        itemStyle: { color: '#8b5cf6' }
                    }
                ],
                animation: false
            };
            
            this.chart.setOption(option);
            
            // Handle resize
            window.addEventListener('resize', () => {
                this.chart.resize();
            });
            
            // Update theme when it changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                this.updateChartTheme();
            });
        },
        
        updateChartTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            this.chart.setOption({
                legend: {
                    textStyle: {
                        color: isDark ? '#a6adba' : '#374151'
                    }
                },
                xAxis: {
                    axisLine: {
                        lineStyle: {
                            color: isDark ? '#4a5568' : '#e5e7eb'
                        }
                    },
                    axisLabel: {
                        color: isDark ? '#a6adba' : '#6b7280'
                    }
                },
                yAxis: {
                    axisLine: {
                        lineStyle: {
                            color: isDark ? '#4a5568' : '#e5e7eb'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    axisLabel: {
                        color: isDark ? '#a6adba' : '#6b7280'
                    }
                }
            });
        },
        
        fetchData() {
            fetch('/api/v1/tasks/status')
                .then(response => response.json())
                .then(data => {
                    // Update stats
                    this.stats = {
                        enqueued: data.enqueued || 0,
                        pending: data.pending || 0,
                        total: data.total_workflows || 0,
                        success: data.success || 0,
                        error: data.error || 0,
                        cancelled: data.cancelled || 0,
                        timestamp: data.timestamp || '-'
                    };
                    
                    // Update queue table
                    this.queueData = [{
                        name: 'DBOS Workflows',
                        type: 'workflow',
                        queued: data.queued_workflows || 0,
                        instance: '-',
                        workers: '-',
                        status: data.message || 'Running',
                        uptime: '-'
                    }];
                    
                    // Update chart data
                    this.updateChartData();
                })
                .catch(error => {
                    console.error('Error fetching queue data:', error);
                    this.stats.timestamp = 'Error';
                });
        },
        
        updateChartData() {
            // Add timestamp
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            this.chartData.labels.push(timeString);
            this.chartData.totalWorkflows.push(this.stats.total);
            this.chartData.enqueued.push(this.stats.enqueued);
            this.chartData.pending.push(this.stats.pending);
            this.chartData.success.push(this.stats.success);
            this.chartData.error.push(this.stats.error);
            this.chartData.cancelled.push(this.stats.cancelled);
            
            // Keep only last maxDataPoints
            if (this.chartData.labels.length > this.maxDataPoints) {
                this.chartData.labels.shift();
                this.chartData.totalWorkflows.shift();
                this.chartData.enqueued.shift();
                this.chartData.pending.shift();
                this.chartData.success.shift();
                this.chartData.error.shift();
                this.chartData.cancelled.shift();
            }
            
            // Update chart
            this.chart.setOption({
                xAxis: {
                    data: this.chartData.labels
                },
                series: [
                    { data: this.chartData.totalWorkflows },
                    { data: this.chartData.enqueued },
                    { data: this.chartData.pending },
                    { data: this.chartData.success },
                    { data: this.chartData.error },
                    { data: this.chartData.cancelled }
                ]
            });
        },
        
        startPolling() {
            if (!this.isPolling) {
                this.isPolling = true;
                this.pollingIntervalId = setInterval(() => {
                    this.fetchData();
                }, this.pollingInterval);
            }
        },
        
        stopPolling() {
            if (this.isPolling) {
                this.isPolling = false;
                clearInterval(this.pollingIntervalId);
                this.pollingIntervalId = null;
            }
        },
        
        togglePolling() {
            if (this.isPolling) {
                this.stopPolling();
            } else {
                this.startPolling();
            }
        },
        
        changeInterval() {
            if (this.isPolling) {
                this.stopPolling();
                this.startPolling();
            }
        }
    }
}
</script>
{% endblock %}
