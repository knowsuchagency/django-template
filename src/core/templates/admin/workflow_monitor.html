{% extends "admin/base_site.html" %}
{% load i18n %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; {% trans 'Queue Monitor' %}
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<!-- Add Apache ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
<style>
    .charts-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
    }

    .chart-module {
        flex: 1;
        min-width: 45%;
    }

    .stats-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        color: #212529;
        border: 1px solid #dee2e6;
    }

    .stat-item {
        flex: 1;
        min-width: 200px;
        text-align: center;
        padding: 15px;
        border-radius: 4px;
        background-color: #ffffff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .stat-value {
        font-size: 1.8em;
        font-weight: bold;
        color: #0d6efd;
        margin-top: 5px;
    }

    .stat-label {
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
    }

    @media (max-width: 992px) {
        .chart-module {
            min-width: 100%;
        }
    }

    .queue-header {
        background-color: #343a40;
        color: #ffffff;
        padding: 10px 15px;
        border-radius: 4px 4px 0 0;
        font-weight: 500;
    }

    /* Styles for control panel */
    .control-panel {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        /* Light background for light mode */
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .control-panel button {
        padding: 8px 16px;
        border-radius: 4px;
        background-color: #79aec8;
        /* Keep consistent with admin theme */
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 500;
    }

    .control-panel button:hover {
        background-color: #6b9cb8;
    }

    .control-panel button.stopped {
        background-color: #28a745;
    }

    .control-panel button.stopped:hover {
        background-color: #218838;
    }

    .control-panel select {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ced4da;
        background-color: #ffffff;
        /* Light background for light mode */
        color: #495057;
    }

    .control-panel label {
        color: #495057;
        /* Dark text for light mode */
        font-weight: 500;
    }

    /* Dark mode specific styles */
    @media (prefers-color-scheme: dark) {
        .stats-container {
            background-color: #2c2c2c;
            /* Darker background */
            border-color: #444;
            color: #e0e0e0;
            /* Lighter text */
        }

        .stat-item {
            background-color: #333;
            /* Darker item background */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            border: 1px solid #484848;
        }

        .stat-value {
            color: #87cefa;
            /* Lighter blue */
        }

        .stat-label {
            color: #a0a0a0;
            /* Lighter grey */
        }

        .queue-header {
            background-color: #444;
            /* Darker header background */
            color: #f0f0f0;
        }

        .control-panel {
            background-color: #2c2c2c;
            /* Darker background */
            border-color: #444;
        }

        .control-panel select {
            background-color: #3a3a3a;
            /* Darker select background */
            color: #e0e0e0;
            /* Lighter text */
            border-color: #555;
        }

        .control-panel label {
            color: #e0e0e0;
            /* Lighter text */
        }

        /* Adjust table colors for dark mode */
        .module table {
            border-color: #444;
        }

        .module table caption {
            color: #e0e0e0;
            background-color: #444;
        }

        .module table thead th {
            background-color: #3a3a3a;
            color: #e0e0e0;
            border-bottom-color: #555;
        }

        .module table tbody td {
            color: #c0c0c0;
            border-bottom-color: #444;
            border-left-color: #444;
        }

        .module table tbody tr:nth-child(odd) td {
            background-color: #333;
        }

        .module table tbody tr:hover td {
            background-color: #4a4a4a;
        }

        /* Adjust legend text colors */
        .module>div[style*="padding: 15px;"] {
            background-color: #2c2c2c !important;
            /* Darker background */
            color: #e0e0e0;
        }

        .module>div[style*="padding: 15px;"] h3 {
            color: #e8e8e8 !important;
        }

        .module>div[style*="padding: 15px;"] p {
            color: #c0c0c0 !important;
        }

        .module>div[style*="padding: 15px;"] code {
            background-color: #444;
            color: #f0f0f0;
            border-color: #555;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Data storage for historical data
        const maxDataPoints = 60; // Store 1 minute of data
        let totalWorkflowsHistory = [];
        let enqueuedHistory = [];
        let pendingHistory = [];
        let successHistory = [];
        let errorHistory = [];
        let cancelledHistory = [];
        let labels = [];

        // Polling controls
        let pollingInterval = 1000; // Default to 1 second
        let pollingIntervalId = null;
        let isPolling = true;

        // Initialize ECharts instance
        const chartDom = document.getElementById('combined-chart');
        const combinedChart = echarts.init(chartDom);
        let option;

        // Determine theme based on system preference
        const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        // Define colors based on theme
        const colors = {
            light: {
                title: '#495057',
                legend: '#495057',
                axisLine: '#ced4da',
                axisLabel: '#495057',
                splitLine: 'rgba(0, 0, 0, 0.1)',
                totalWorkflows: 'rgb(53, 162, 235)',
                enqueued: 'rgb(255, 206, 86)',
                pending: 'rgb(255, 159, 64)',
                success: 'rgb(75, 192, 192)',
                error: 'rgb(255, 99, 132)',
                cancelled: 'rgb(153, 102, 255)',
                background: '#ffffff'
            },
            dark: {
                title: '#e0e0e0',
                legend: '#a0a0a0',
                axisLine: '#555',
                axisLabel: '#a0a0a0',
                splitLine: 'rgba(255, 255, 255, 0.1)',
                totalWorkflows: 'rgb(87, 189, 255)', // Lighter blue
                enqueued: 'rgb(255, 235, 59)', // Yellow
                pending: 'rgb(255, 183, 77)', // Orange
                success: 'rgb(118, 218, 218)', // Lighter teal
                error: 'rgb(255, 138, 166)', // Lighter red
                cancelled: 'rgb(188, 155, 255)', // Lighter purple
                background: '#2c2c2c' // Match container background
            }
        };
        const currentColors = isDarkMode ? colors.dark : colors.light;

        // Initial chart configuration
        option = {
            backgroundColor: currentColors.background, // Set background color
            title: {
                text: 'Workflow Activity Monitor',
                left: 'center',
                textStyle: {
                    color: currentColors.title,
                    fontSize: 16
                }
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['Total Workflows', 'Enqueued', 'Pending', 'Success', 'Error', 'Cancelled'],
                top: 'bottom',
                textStyle: {
                    color: currentColors.legend
                }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '10%', // Adjust bottom to make space for legend
                containLabel: true
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: labels,
                axisLine: {
                    lineStyle: {
                        color: currentColors.axisLine
                    }
                },
                axisLabel: {
                    color: currentColors.axisLabel
                }
            },
            yAxis: {
                type: 'value',
                axisLine: {
                    show: true, // Show Y axis line
                    lineStyle: {
                        color: currentColors.axisLine
                    }
                },
                splitLine: {
                    lineStyle: {
                        color: currentColors.splitLine
                    }
                },
                axisLabel: {
                    color: currentColors.axisLabel
                }
            },
            series: [
                {
                    name: 'Total Workflows',
                    type: 'line',
                    smooth: true,
                    data: totalWorkflowsHistory,
                    lineStyle: { width: 3 },
                    itemStyle: { color: currentColors.totalWorkflows }
                },
                {
                    name: 'Enqueued',
                    type: 'line',
                    smooth: true,
                    data: enqueuedHistory,
                    lineStyle: { width: 3 },
                    itemStyle: { color: currentColors.enqueued }
                },
                {
                    name: 'Pending',
                    type: 'line',
                    smooth: true,
                    data: pendingHistory,
                    lineStyle: { width: 3 },
                    itemStyle: { color: currentColors.pending }
                },
                {
                    name: 'Success',
                    type: 'line',
                    smooth: true,
                    data: successHistory,
                    lineStyle: { width: 3 },
                    itemStyle: { color: currentColors.success }
                },
                {
                    name: 'Error',
                    type: 'line',
                    smooth: true,
                    data: errorHistory,
                    lineStyle: { width: 3 },
                    itemStyle: { color: currentColors.error }
                },
                {
                    name: 'Cancelled',
                    type: 'line',
                    smooth: true,
                    data: cancelledHistory,
                    lineStyle: { width: 3 },
                    itemStyle: { color: currentColors.cancelled }
                }
            ],
            animation: false // Disable animation for performance
        };

        combinedChart.setOption(option);

        function addTimeLabel() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            labels.push(timeString);

            // Keep only the last maxDataPoints labels
            if (labels.length > maxDataPoints) {
                labels.shift();
            }
        }

        function updateCharts(data) {
            // Add a new time label
            addTimeLabel();

            // Update total workflows history
            totalWorkflowsHistory.push(data.total_workflows);
            if (totalWorkflowsHistory.length > maxDataPoints) {
                totalWorkflowsHistory.shift();
            }

            // Update enqueued history
            enqueuedHistory.push(data.enqueued);
            if (enqueuedHistory.length > maxDataPoints) {
                enqueuedHistory.shift();
            }

            // Update pending history
            pendingHistory.push(data.pending);
            if (pendingHistory.length > maxDataPoints) {
                pendingHistory.shift();
            }

            // Update success history
            successHistory.push(data.success);
            if (successHistory.length > maxDataPoints) {
                successHistory.shift();
            }

            // Update error history
            errorHistory.push(data.error);
            if (errorHistory.length > maxDataPoints) {
                errorHistory.shift();
            }

            // Update cancelled history
            cancelledHistory.push(data.cancelled);
            if (cancelledHistory.length > maxDataPoints) {
                cancelledHistory.shift();
            }

            // Update the ECharts chart
            combinedChart.setOption({
                xAxis: {
                    data: labels
                },
                series: [
                    { name: 'Total Workflows', data: totalWorkflowsHistory },
                    { name: 'Enqueued', data: enqueuedHistory },
                    { name: 'Pending', data: pendingHistory },
                    { name: 'Success', data: successHistory },
                    { name: 'Error', data: errorHistory },
                    { name: 'Cancelled', data: cancelledHistory }
                ]
            });
        }

        function getRandomColor() {
            // Use more saturated colors for better visibility in light mode
            const hue = Math.floor(Math.random() * 360);
            return `hsl(${hue}, 70%, 45%)`;
        }

        function fetchQueueData() {
            fetch('/api/v1/tasks/status')
                .then(response => response.json())
                .then(data => {
                    // Update status counts and timestamp
                    document.getElementById('enqueued-count').textContent = data.enqueued || 0;
                    document.getElementById('pending-count').textContent = data.pending || 0;
                    document.getElementById('total-count').textContent = data.total_workflows || 0;
                    document.getElementById('success-count').textContent = data.success || 0;
                    document.getElementById('error-count').textContent = data.error || 0;
                    document.getElementById('cancelled-count').textContent = data.cancelled || 0;
                    document.getElementById('timestamp').textContent = data.timestamp;

                    // Update queue table - DBOS doesn't have multiple queues
                    const tableBody = document.getElementById('queue-table-body');
                    tableBody.innerHTML = '';
                    
                    // Add single row for DBOS workflows
                    const row = document.createElement('tr');
                    row.innerHTML = `
                      <td>DBOS Workflows</td>
                      <td>workflow</td>
                      <td>${data.queued_workflows || 0}</td>
                      <td>-</td>
                      <td>-</td>
                      <td>${data.message || 'Running'}</td>
                      <td>-</td>
                    `;
                    tableBody.appendChild(row);

                    // Update charts with new data (adapted for DBOS)
                    updateCharts({
                        total_workflows: data.total_workflows || 0,
                        enqueued: data.enqueued || 0,
                        pending: data.pending || 0,
                        success: data.success || 0,
                        error: data.error || 0,
                        cancelled: data.cancelled || 0
                    });
                })
                .catch(error => {
                    console.error('Error fetching queue data:', error);
                    // Show error in UI
                    document.getElementById('timestamp').textContent = 'Error';
                });
        }

        // New functions to control polling
        function startPolling() {
            if (!isPolling) {
                pollingIntervalId = setInterval(fetchQueueData, pollingInterval);
                isPolling = true;
                updateToggleButton();
            }
        }

        function stopPolling() {
            if (isPolling) {
                clearInterval(pollingIntervalId);
                isPolling = false;
                updateToggleButton();
            }
        }

        function togglePolling() {
            if (isPolling) {
                stopPolling();
            } else {
                startPolling();
            }
        }

        function updateToggleButton() {
            const toggleButton = document.getElementById('toggle-polling');
            if (isPolling) {
                toggleButton.textContent = 'Stop Polling';
                toggleButton.classList.remove('stopped');
            } else {
                toggleButton.textContent = 'Start Polling';
                toggleButton.classList.add('stopped');
            }
        }

        function changeInterval() {
            const intervalSelect = document.getElementById('polling-interval');
            pollingInterval = parseInt(intervalSelect.value);

            // Restart polling with new interval if currently polling
            if (isPolling) {
                stopPolling();
                startPolling();
            }
        }

        // Setup event listeners for controls
        document.getElementById('toggle-polling').addEventListener('click', togglePolling);
        document.getElementById('polling-interval').addEventListener('change', changeInterval);
        document.getElementById('refresh-now').addEventListener('click', fetchQueueData);

        // Fetch initial data
        fetchQueueData();

        // Start initial polling
        pollingIntervalId = setInterval(fetchQueueData, pollingInterval);
        updateToggleButton();

        // Listen for changes in color scheme preference
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            const newColorScheme = event.matches ? "dark" : "light";
            const newColors = colors[newColorScheme];
            combinedChart.setOption({
                backgroundColor: newColors.background,
                title: { textStyle: { color: newColors.title } },
                legend: { textStyle: { color: newColors.legend } },
                xAxis: {
                    axisLine: { lineStyle: { color: newColors.axisLine } },
                    axisLabel: { color: newColors.axisLabel }
                },
                yAxis: {
                    axisLine: { lineStyle: { color: newColors.axisLine } },
                    splitLine: { lineStyle: { color: newColors.splitLine } },
                    axisLabel: { color: newColors.axisLabel }
                },
                series: [
                    { name: 'Total Workflows', itemStyle: { color: newColors.totalWorkflows } },
                    { name: 'Enqueued', itemStyle: { color: newColors.enqueued } },
                    { name: 'Pending', itemStyle: { color: newColors.pending } },
                    { name: 'Success', itemStyle: { color: newColors.success } },
                    { name: 'Error', itemStyle: { color: newColors.error } },
                    { name: 'Cancelled', itemStyle: { color: newColors.cancelled } }
                ]
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>Workflow Monitor (DBOS)</h1>

    <!-- Control Panel -->
    <div class="module">
        <div class="queue-header">Control Panel</div>
        <div class="control-panel">
            <button id="toggle-polling">Stop Polling</button>
            <label for="polling-interval">Polling Interval:</label>
            <select id="polling-interval" style="min-height: 36px;">
                <option value="500">0.5 seconds</option>
                <option value="1000" selected>1 second</option>
                <option value="2000">2 seconds</option>
                <option value="5000">5 seconds</option>
                <option value="10000">10 seconds</option>
                <option value="30000">30 seconds</option>
                <option value="60000">1 minute</option>
            </select>
            <!-- Add a manual refresh button -->
            <button id="refresh-now" style="background-color: #5a8dee;">Refresh Now</button>
        </div>
    </div>

    <!-- Charts section - now using ECharts -->
    <div class="module">
        <div class="queue-header">Workflow Activity Monitor</div>
        <div
            style="height: 400px; padding: 15px; background-color: #ffffff; border-radius: 0 0 4px 4px; border: 1px solid #dee2e6;">
            <div id="combined-chart" style="width: 100%; height: 100%;"></div>
        </div>
    </div>

    <!-- Stats below the chart -->
    <div class="module">
        <div class="queue-header">Workflow Status Summary</div>
        <div class="stats-container">
            <div class="stat-item">
                <div class="stat-label">Enqueued</div>
                <div class="stat-value" id="enqueued-count">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Pending</div>
                <div class="stat-value" id="pending-count">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Total Workflows</div>
                <div class="stat-value" id="total-count">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Success</div>
                <div class="stat-value" id="success-count">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Error</div>
                <div class="stat-value" id="error-count">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Cancelled</div>
                <div class="stat-value" id="cancelled-count">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Last Updated</div>
                <div class="stat-value" id="timestamp">-</div>
            </div>
        </div>
    </div>

    <div class="module">
        <table>
            <caption>Workflow System Status</caption>
            <thead>
                <tr>
                    <th>System</th>
                    <th>Type</th>
                    <th>Queued Workflows</th>
                    <th>Instance ID</th>
                    <th>Workers</th>
                    <th>Status</th>
                    <th>Uptime</th>
                </tr>
            </thead>
            <tbody id="queue-table-body">
                <!-- Queue data will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Add Legend for Workflow Metrics -->
    <div class="module">
        <div class="queue-header">Workflow Metrics Legend</div>
        <div style="padding: 15px; background-color: #ffffff; border-radius: 0 0 4px 4px; border: 1px solid #dee2e6;">
            <div style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 8px 0; color: #495057;">ENQUEUED</h3>
                <p>Workflows waiting in the queue to be executed. These have been submitted but are waiting for resources.</p>
            </div>

            <div style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 8px 0; color: #495057;">PENDING</h3>
                <p>Workflows that are currently being executed or are about to start execution.</p>
            </div>

            <div style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 8px 0; color: #495057;">SUCCESS</h3>
                <p>Workflows that have successfully completed execution without errors.</p>
            </div>

            <div style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 8px 0; color: #495057;">ERROR</h3>
                <p>Workflows that encountered errors during execution. DBOS may retry these based on your configuration.</p>
            </div>

            <div style="margin-bottom: 15px;">
                <h3 style="margin: 0 0 8px 0; color: #495057;">MAX_RECOVERY_ATTEMPTS_EXCEEDED</h3>
                <p>Workflows that failed after exhausting all retry attempts. These require manual intervention or debugging.</p>
            </div>

            <div>
                <h3 style="margin: 0 0 8px 0; color: #495057;">CANCELLED</h3>
                <p>Workflows that were manually cancelled before completion.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
