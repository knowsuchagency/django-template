{% extends "admin/base_site.html" %}
{% load i18n %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; {% trans 'Queue Monitor' %}
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<!-- Tailwind CSS, DaisyUI, and Alpine.js -->
<link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<script src="//unpkg.com/alpinejs" defer></script>
<!-- ECharts for visualization -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
<script>
    // Set DaisyUI theme based on system preference
    function setThemeFromSystemPreference() {
        const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', prefersDarkMode ? 'dark' : 'light');
    }
    setThemeFromSystemPreference();
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', setThemeFromSystemPreference);
</script>
{% endblock %}

{% block content %}
<div id="content-main" x-data="workflowMonitor()" x-init="init()">
    <h1 class="text-2xl font-bold mb-6">Workflow Monitor (DBOS)</h1>

    <!-- Control Panel -->
    <div class="card bg-base-200 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title">Control Panel</h2>
            <div class="flex flex-wrap gap-4 items-center">
                <button 
                    @click="togglePolling()" 
                    :class="isPolling ? 'btn-error' : 'btn-success'"
                    class="btn"
                    x-text="isPolling ? 'Stop Polling' : 'Start Polling'">
                </button>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Polling Interval:</span>
                    </label>
                    <select 
                        x-model="pollingInterval" 
                        @change="changeInterval()"
                        class="select select-bordered">
                        <option value="500">0.5 seconds</option>
                        <option value="1000">1 second</option>
                        <option value="2000">2 seconds</option>
                        <option value="5000">5 seconds</option>
                        <option value="10000">10 seconds</option>
                        <option value="30000">30 seconds</option>
                        <option value="60000">1 minute</option>
                    </select>
                </div>
                
                <button @click="fetchData()" class="btn btn-primary">
                    Refresh Now
                </button>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="card bg-base-200 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title">Workflow Activity Monitor</h2>
            <div id="combined-chart" class="w-full h-96"></div>
        </div>
    </div>

    <!-- Stats -->
    <div class="card bg-base-200 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title mb-4">Workflow Status Summary</h2>
            <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
                <div class="stat">
                    <div class="stat-title">Enqueued</div>
                    <div class="stat-value text-warning" x-text="stats.enqueued">-</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Pending</div>
                    <div class="stat-value text-info" x-text="stats.pending">-</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Total Workflows</div>
                    <div class="stat-value text-primary" x-text="stats.total">-</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Success</div>
                    <div class="stat-value text-success" x-text="stats.success">-</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Error</div>
                    <div class="stat-value text-error" x-text="stats.error">-</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Cancelled</div>
                    <div class="stat-value text-secondary" x-text="stats.cancelled">-</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Last Updated</div>
                    <div class="stat-value text-sm" x-text="stats.timestamp">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status Table -->
    <div class="card bg-base-200 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title">Workflow System Status</h2>
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>System</th>
                            <th>Type</th>
                            <th>Queued Workflows</th>
                            <th>Instance ID</th>
                            <th>Workers</th>
                            <th>Status</th>
                            <th>Uptime</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="queue in queueData" :key="queue.name">
                            <tr>
                                <td x-text="queue.name"></td>
                                <td x-text="queue.type"></td>
                                <td x-text="queue.queued"></td>
                                <td x-text="queue.instance"></td>
                                <td x-text="queue.workers"></td>
                                <td x-text="queue.status"></td>
                                <td x-text="queue.uptime"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="card bg-base-200 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Workflow Metrics Legend</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="font-bold text-warning">ENQUEUED</h3>
                    <p class="text-sm opacity-70">Workflows waiting in the queue to be executed. These have been submitted but are waiting for resources.</p>
                </div>
                <div>
                    <h3 class="font-bold text-info">PENDING</h3>
                    <p class="text-sm opacity-70">Workflows that are currently being executed or are about to start execution.</p>
                </div>
                <div>
                    <h3 class="font-bold text-success">SUCCESS</h3>
                    <p class="text-sm opacity-70">Workflows that have successfully completed execution without errors.</p>
                </div>
                <div>
                    <h3 class="font-bold text-error">ERROR</h3>
                    <p class="text-sm opacity-70">Workflows that encountered errors during execution. DBOS may retry these based on your configuration.</p>
                </div>
                <div>
                    <h3 class="font-bold text-error">MAX_RECOVERY_ATTEMPTS_EXCEEDED</h3>
                    <p class="text-sm opacity-70">Workflows that failed after exhausting all retry attempts. These require manual intervention or debugging.</p>
                </div>
                <div>
                    <h3 class="font-bold text-secondary">CANCELLED</h3>
                    <p class="text-sm opacity-70">Workflows that were manually cancelled before completion.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function workflowMonitor() {
    return {
        // State
        isPolling: true,
        pollingInterval: 1000,
        pollingIntervalId: null,
        chart: null,
        
        // Data
        stats: {
            enqueued: 0,
            pending: 0,
            total: 0,
            success: 0,
            error: 0,
            cancelled: 0,
            timestamp: '-'
        },
        queueData: [],
        
        // Chart data
        maxDataPoints: 60,
        chartData: {
            labels: [],
            totalWorkflows: [],
            enqueued: [],
            pending: [],
            success: [],
            error: [],
            cancelled: []
        },
        
        init() {
            this.initChart();
            this.fetchData();
            this.startPolling();
        },
        
        initChart() {
            const chartDom = document.getElementById('combined-chart');
            this.chart = echarts.init(chartDom);
            
            // Get current theme
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            
            const option = {
                backgroundColor: 'transparent',
                title: {
                    text: '',
                },
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['Total Workflows', 'Enqueued', 'Pending', 'Success', 'Error', 'Cancelled'],
                    bottom: 0,
                    textStyle: {
                        color: isDark ? '#a6adba' : '#374151'
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: this.chartData.labels,
                    axisLine: {
                        lineStyle: {
                            color: isDark ? '#4a5568' : '#e5e7eb'
                        }
                    },
                    axisLabel: {
                        color: isDark ? '#a6adba' : '#6b7280'
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: {
                        show: true,
                        lineStyle: {
                            color: isDark ? '#4a5568' : '#e5e7eb'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    axisLabel: {
                        color: isDark ? '#a6adba' : '#6b7280'
                    }
                },
                series: [
                    {
                        name: 'Total Workflows',
                        type: 'line',
                        smooth: true,
                        data: this.chartData.totalWorkflows,
                        lineStyle: { width: 2 },
                        itemStyle: { color: '#3b82f6' }
                    },
                    {
                        name: 'Enqueued',
                        type: 'line',
                        smooth: true,
                        data: this.chartData.enqueued,
                        lineStyle: { width: 2 },
                        itemStyle: { color: '#f59e0b' }
                    },
                    {
                        name: 'Pending',
                        type: 'line',
                        smooth: true,
                        data: this.chartData.pending,
                        lineStyle: { width: 2 },
                        itemStyle: { color: '#06b6d4' }
                    },
                    {
                        name: 'Success',
                        type: 'line',
                        smooth: true,
                        data: this.chartData.success,
                        lineStyle: { width: 2 },
                        itemStyle: { color: '#10b981' }
                    },
                    {
                        name: 'Error',
                        type: 'line',
                        smooth: true,
                        data: this.chartData.error,
                        lineStyle: { width: 2 },
                        itemStyle: { color: '#ef4444' }
                    },
                    {
                        name: 'Cancelled',
                        type: 'line',
                        smooth: true,
                        data: this.chartData.cancelled,
                        lineStyle: { width: 2 },
                        itemStyle: { color: '#8b5cf6' }
                    }
                ],
                animation: false
            };
            
            this.chart.setOption(option);
            
            // Handle resize
            window.addEventListener('resize', () => {
                this.chart.resize();
            });
            
            // Update theme when it changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                this.updateChartTheme();
            });
        },
        
        updateChartTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            this.chart.setOption({
                legend: {
                    textStyle: {
                        color: isDark ? '#a6adba' : '#374151'
                    }
                },
                xAxis: {
                    axisLine: {
                        lineStyle: {
                            color: isDark ? '#4a5568' : '#e5e7eb'
                        }
                    },
                    axisLabel: {
                        color: isDark ? '#a6adba' : '#6b7280'
                    }
                },
                yAxis: {
                    axisLine: {
                        lineStyle: {
                            color: isDark ? '#4a5568' : '#e5e7eb'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    axisLabel: {
                        color: isDark ? '#a6adba' : '#6b7280'
                    }
                }
            });
        },
        
        fetchData() {
            fetch('/api/v1/tasks/status')
                .then(response => response.json())
                .then(data => {
                    // Update stats
                    this.stats = {
                        enqueued: data.enqueued || 0,
                        pending: data.pending || 0,
                        total: data.total_workflows || 0,
                        success: data.success || 0,
                        error: data.error || 0,
                        cancelled: data.cancelled || 0,
                        timestamp: data.timestamp || '-'
                    };
                    
                    // Update queue table
                    this.queueData = [{
                        name: 'DBOS Workflows',
                        type: 'workflow',
                        queued: data.queued_workflows || 0,
                        instance: '-',
                        workers: '-',
                        status: data.message || 'Running',
                        uptime: '-'
                    }];
                    
                    // Update chart data
                    this.updateChartData();
                })
                .catch(error => {
                    console.error('Error fetching queue data:', error);
                    this.stats.timestamp = 'Error';
                });
        },
        
        updateChartData() {
            // Add timestamp
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            this.chartData.labels.push(timeString);
            this.chartData.totalWorkflows.push(this.stats.total);
            this.chartData.enqueued.push(this.stats.enqueued);
            this.chartData.pending.push(this.stats.pending);
            this.chartData.success.push(this.stats.success);
            this.chartData.error.push(this.stats.error);
            this.chartData.cancelled.push(this.stats.cancelled);
            
            // Keep only last maxDataPoints
            if (this.chartData.labels.length > this.maxDataPoints) {
                this.chartData.labels.shift();
                this.chartData.totalWorkflows.shift();
                this.chartData.enqueued.shift();
                this.chartData.pending.shift();
                this.chartData.success.shift();
                this.chartData.error.shift();
                this.chartData.cancelled.shift();
            }
            
            // Update chart
            this.chart.setOption({
                xAxis: {
                    data: this.chartData.labels
                },
                series: [
                    { data: this.chartData.totalWorkflows },
                    { data: this.chartData.enqueued },
                    { data: this.chartData.pending },
                    { data: this.chartData.success },
                    { data: this.chartData.error },
                    { data: this.chartData.cancelled }
                ]
            });
        },
        
        startPolling() {
            if (!this.isPolling) {
                this.isPolling = true;
                this.pollingIntervalId = setInterval(() => {
                    this.fetchData();
                }, this.pollingInterval);
            }
        },
        
        stopPolling() {
            if (this.isPolling) {
                this.isPolling = false;
                clearInterval(this.pollingIntervalId);
                this.pollingIntervalId = null;
            }
        },
        
        togglePolling() {
            if (this.isPolling) {
                this.stopPolling();
            } else {
                this.startPolling();
            }
        },
        
        changeInterval() {
            if (this.isPolling) {
                this.stopPolling();
                this.startPolling();
            }
        }
    }
}
</script>
{% endblock %}